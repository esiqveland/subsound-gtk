id: com.github.Subsound
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk25
command: /app/bin/Subsound.sh
finish-args:
  - "--env=PATH=/app/jre/bin:/usr/bin"
  - "--env=JAVA_HOME=/app/jre"
  - "--env=JAVA_OPTS=--enable-native-access=ALL-UNNAMED"
  - "--env=JAVA_LOG_LEVEL=WARN"
  - "--socket=pulseaudio"
  - "--socket=wayland"
  - "--socket=fallback-x11"
  - "--share=ipc"
  - "--share=network"
  - "--own-name=org.mpris.MediaPlayer2.Subsound"
  # Direct Rendering Interface. Necessary for GL. # TODO: Is this needed for accelerated GTK rendering?
  - "--device=dri"
  - "--filesystem=xdg-config:create"
  - "--filesystem=xdg-cache:create"
  - "--filesystem=xdg-data:create"
  # Pipewire like this might trigger a "Potentially unsafe" warning in tools like Flatseal because it can potentially allow broader system access
  #- "--filesystem=xdg-run/pipewire-0:ro"
modules:
  - name: openjdk
    buildsystem: 'simple'
    build-commands:
      - "/usr/lib/sdk/openjdk25/install.sh"
  - name: Subsound
    buildsystem: simple
    build-options:
      append-path: "/usr/lib/sdk/openjdk25/jvm/openjdk-25/bin"
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk25/jvm/openjdk-25
    build-commands:
      # We make the Gradle wrapper use our local .zip file
      # NOTA: mind the fact that expand() will reduce the backslashes in template, so double them!
      - ln --force gradle-9.3.0-all.zip gradle/wrapper/gradle-9.3.0-all.zip
      - >-
        sed --regexp-extended --in-place
        's,https\\://services.gradle.org/distributions/,file:\/run/build/Subsound/,'
        gradle/wrapper/gradle-wrapper.properties
      - bash gradlew --offline build
      # Extract libs and bin from gradle build *.tar file to /app
      - tar vx --directory=/app --strip-components=1 --file build/distributions/*shadow*.tar
      - install -Dm755 Subsound.sh /app/bin/Subsound.sh
      # install icons and desktop files:
      - install --mode=0644 -D src/main/resources/icons/generated/icon-256.png /app/share/icons/hicolor/256x256/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-64.png  /app/share/icons/hicolor/64x64/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-48.png  /app/share/icons/hicolor/48x48/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-32.png  /app/share/icons/hicolor/32x32/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-24.png  /app/share/icons/hicolor/24x24/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-16.png  /app/share/icons/hicolor/16x16/apps/com.github.Subsound.png
      - install --mode=0644 -D com.github.Subsound.desktop  /app/share/applications/com.github.Subsound.desktop
      - install --mode=0644 -D com.github.Subsound.metainfo.xml /app/share/metainfo/com.github.Subsound.metainfo.xml
    only-arches:
      - x86_64
    sources:
      # We use the Subsound.sh script to rename the process we start, so its not just named 'java':
      - type: file
        path: src/main/resources/app/Subsound.sh
      - type: file
        path: src/main/resources/app/com.github.Subsound.desktop
      - type: file
        path: src/main/resources/app/com.github.Subsound.metainfo.xml
      - type: file
        url: https://services.gradle.org/distributions/gradle-9.3.0-all.zip
        sha256: 046f36af261f2c6ed09eef06bf25b93d1f20d5220991bb8a3f08fd5fb6f6629a
      - type: git
        url: https://github.com/esiqveland/subsound-gtk
        tag: v0.2.0
      # Include app flatpak-sources.json, generated by Gradle task flatpakGradleGenerator
      - 'flatpak-sources.json'






