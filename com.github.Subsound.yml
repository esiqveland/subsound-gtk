id: com.github.Subsound
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
add-extensions:
  - "org.freedesktop.Sdk.Extension.openjdk"
sdk-extensions:
  - "org.freedesktop.Sdk.Extension.openjdk"
build-options:
  append-path: "/usr/lib/sdk/openjdk/bin"
command: /app/bin/Subsound.sh
finish-args:
  - "--env=PATH=/app/jre/bin:/usr/bin"
  - "--env=JAVA_HOME=/app/jre"
  - "--env=JAVA_OPTS=--enable-native-access=ALL-UNNAMED"
  - "--socket=pulseaudio"
  - "--socket=wayland"
  - "--socket=fallback-x11"
  - "--share=ipc"
  - "--share=network"
  # Direct Rendering Interface. Necessary for GL. # TODO: Is this needed for accelerated GTK rendering?
  - "--device=dri"
  - "--filesystem=xdg-config:create"
  - "--filesystem=xdg-cache:create"
  - "--filesystem=xdg-data:create"
  #- "--talk-name=org.freedesktop.FileManager1",
  #- "--filesystem=home:rw"
modules:
  - name: openjdk
    buildsystem: 'simple'
    only-arches:
      - x86_64
    build-commands:
      - "/usr/lib/sdk/openjdk/install.sh"
  - name: Subsound
    buildsystem: simple
    build-commands:
      # We make the Gradle wrapper use our local .zip file
      # NOTA: mind the fact that expand() will reduce the backslashes in template, so double them!
      - ln --force gradle-8.9-all.zip gradle/wrapper/gradle-8.9-all.zip
      - ls -la offline-repository
      - >-
        sed --regexp-extended --in-place
        's,https\\://services.gradle.org/distributions/,file:\/run/build/Subsound/,'
        gradle/wrapper/gradle-wrapper.properties
      - bash gradlew --offline build
      - ls -la build/distributions
      # Extract libs and bin from gradle build *.tar file to /app
      - tar vx --directory=/app --strip-components=1 --file build/distributions/*shadow*.tar
      - ls -la /app
      - ls -la /app/bin
      - install -Dm755 Subsound.sh /app/bin/Subsound.sh
      # install icons and desktop files:
      - install --mode=0644 -D src/main/resources/icons/generated/icon-256.png /app/share/icons/hicolor/256x256/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-64.png  /app/share/icons/hicolor/64x64/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-48.png  /app/share/icons/hicolor/48x48/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-32.png  /app/share/icons/hicolor/32x32/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-24.png  /app/share/icons/hicolor/24x24/apps/com.github.Subsound.png
      - install --mode=0644 -D src/main/resources/icons/generated/icon-16.png  /app/share/icons/hicolor/16x16/apps/com.github.Subsound.png
    only-arches:
      - x86_64
    sources:
      # We use the Subsound.sh script to rename the process we start, so its not just named 'java':
      - type: script
        dest-filename: Subsound.sh
        commands:
          - exec -a Subsound java $JAVA_OPTS -jar /app/lib/subsound-*.jar
      - type: git
        url: https://github.com/esiqveland/subsound-gtk
        tag: v0.1.0-alpha13
      - type: file
        url: https://services.gradle.org/distributions/gradle-8.9-all.zip
        sha256: 258e722ec21e955201e31447b0aed14201765a3bfbae296a46cf60b70e66db70
      # Include app flatpak-sources.json, generated by Gradle task flatpakGradleGenerator
      - 'flatpak-sources.json'






